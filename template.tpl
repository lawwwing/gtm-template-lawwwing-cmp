___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Lawwwing CMP",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Lawwwing, builds technology to empower businesses to navigate the complex landscape of data privacy laws, like GDPR, ePrivacy, and CCPA, ensuring compliance and building trust. https://lawwwing.com",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "defaultSettings",
    "displayName": "Set Google Consent Mode default status",
    "groupStyle": "NO_ZIPPY",
    "subParams": [],
    "help": "These fields are denied by default for all regions unless overwritten with a blank region field"
  },
  {
    "type": "PARAM_TABLE",
    "name": "defaultsOverrides",
    "displayName": "",
    "paramTableColumns": [
      {
        "param": {
          "type": "SELECT",
          "name": "analytics",
          "displayName": "Analytics Storage",
          "macrosInSelect": false,
          "selectItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "help": "Allow analytics cookies before user gives consent",
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "advertisement",
          "displayName": "Advertisement Storage",
          "macrosInSelect": false,
          "selectItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "help": "Allow advertising cookies before user gives consent",
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "functionality",
          "displayName": "Functionality Storage",
          "macrosInSelect": false,
          "selectItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "help": "Allow functionality cookies before user gives consent",
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "personalization",
          "displayName": "Personalization Storage",
          "macrosInSelect": false,
          "selectItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "help": "Allow personalized recommendation cookies before user gives consent",
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_user_data",
          "displayName": "Ads User Data",
          "macrosInSelect": false,
          "selectItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "help": "Sets consent for sending user data related to advertising to Google.",
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_personalization",
          "displayName": "Ads Personalization",
          "macrosInSelect": false,
          "selectItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "help": "Sets consent for personalized advertising.",
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "TEXT",
          "name": "Region",
          "displayName": "Region (leave field blank to apply to all regions)",
          "simpleValueType": true,
          "help": "Specify a comma-separated list of \u003ca href\u003d\"https://en.wikipedia.org/wiki/ISO_3166-2\"\u003eregions\u003c/a\u003e for which you want to apply this setting."
        },
        "isUnique": false
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalSetttings",
    "displayName": "Additional Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "adsDataRedaction",
        "checkboxText": "Redact ads data",
        "simpleValueType": true,
        "help": "To further redact your ads data when ad_storage is denied",
        "defaultValue": false
      },
      {
        "type": "CHECKBOX",
        "name": "urlPassThrough",
        "checkboxText": "Passing information in URLs",
        "simpleValueType": true,
        "help": "Passing ad click, client ID, and session ID information in URLs",
        "defaultValue": false
      },
      {
        "type": "TEXT",
        "name": "waitForUpdate",
        "displayName": "Wait for update",
        "simpleValueType": true,
        "defaultValue": 2000,
        "help": "Time waiting for consent before Google Tags fire ( must be greater than 500ms).",
        "valueUnit": "miliseconds",
        "valueValidators": [
          {
            "type": "NUMBER"
          },
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "injectSDK",
    "displayName": "Embed Lawwwing",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "embedLawwwing",
        "checkboxText": "Embed Lawwwing SDK",
        "simpleValueType": true,
        "help": "Automatically embed the Lawwwing SDK from GTM. Make sure to disable this option if you embed the Lawwwing SDK directly on your website. We recommend embedding the Lawwwing SDK directly in the source code for your website as it is more performant than via GTM.",
        "defaultValue": false,
        "displayName": "Embed the Lawwwing SDK on your website from GTM"
      },
      {
        "type": "TEXT",
        "name": "lwID",
        "displayName": "Lawwwing ID",
        "simpleValueType": true,
        "help": "Your website installation ID from the Lawwwing Dashboard. This must be provided for the Lawwwing SDK to be embedded on your website.",
        "enablingConditions": [
          {
            "paramName": "embedLawwwing",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "\\b(uuid:){0,1}\\s*([a-f0-9\\\\-]*){1}\\s*"
            ]
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/**
 * ====== Lawwwing CMP  ======
 * Google Consent Mode Integration
 */
const createQueue = require('createQueue');
const encodeUriComponent = require('encodeUriComponent');
const gtagSet = require('gtagSet');
const injectScript = require("injectScript");
const log = require('logToConsole');
const queryPermission = require("queryPermission");
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');

const GCM_PURPOSES = {
  ad_storage: 'advertisement',
  ad_user_data: 'ad_user_data',
  ad_personalization: 'ad_personalization',
  analytics_storage: 'analytics',
  functionality_storage: 'functionality',
  personalization_storage: 'personalization',
};

/**
 * Splits the input string using comma as a delimiter, returning an array of strings
 */
const _split_string = (string) => {
  return string.split(',')
      .map(entry => entry.trim())
      .filter(entry => entry.length !== 0);
};

/**
 * Sets default consent settings and override them if setted on data
 * from configuration.
 */
const setDefaultSettings = (data) => {
  setDefaultConsentState({
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied',
    'functionality_storage': 'denied',
    'personalization_storage': 'denied',
    'security_storage': 'granted',
    'wait_for_update': data.waitForUpdate,
  });

  if (data.defaultsOverrides && data.defaultsOverrides.length > 0) {
    data.defaultsOverrides.forEach(row => {
      const overrides = {
        'ad_storage': row[GCM_PURPOSES.ad_storage],
        'ad_user_data': row[GCM_PURPOSES.ad_user_data],
        'ad_personalization': row[GCM_PURPOSES.ad_personalization],
        'analytics_storage': row[GCM_PURPOSES.analytics_storage],
        'functionality_storage': row[GCM_PURPOSES.functionality_storage],
        'personalization_storage': row[GCM_PURPOSES.personalization_storage],
        'security_storage': 'granted',
        'wait_for_update': data.waitForUpdate,
      };
      const regions = _split_string(row.region);
      if (regions.length > 0) {
        overrides.region = regions;
      }
      // Set defaults overriding per region if setted
      setDefaultConsentState(overrides);
    });
  }
  // Set default additional settings values
  gtagSet('ads_data_redaction', !!data.adsDataRedaction);
  gtagSet('url_passthrough', !!data.urlPassThrough);
};

/**
 * Function to update consent state. Will be called when a consent update
 * event is triggered on lawwwing sdk.
 */
const updateConsent = (consent) => {
  updateConsentState(consent);
};

/**
 * Function to register event listeners for consent change updates
 */
const setupEventListeners = () => {
  const eventPush = createQueue('LawwwingEventListeners');
  eventPush({
    event: 'consent.update',
    handler: updateConsent,
  });
};

/**
 * Function to embed Lawwwing SDK
 */
const embedLawwwing = (data) => {
  let _script_src = "https://cdn.lawwwing.com/widgets/current/" + encodeUriComponent(data.lwID) + "/cookie-widget.min.js";
  if (!queryPermission("inject_script", _script_src)) {
    return data.gtmOnFailure();
  }
  injectScript(_script_src, data.gtmOnSuccess, data.gtmOnFailure);
};

/**
 * Executes the default command.
 */
const main = (data) => {
  gtagSet({"developer_id.dY2E2Yz": true});

  setDefaultSettings(data);
  setupEventListeners();

  if (data.embedLawwwing) {
    embedLawwwing(data);
  }
};

main(data);
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "LawwwingEventListeners"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Lawwwing"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "developer_id.dY2E2Yz"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.lawwwing.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Default consent values are set OK
  code: |-
    // Call runCode to run the template's code.
    runCode(defaultMockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
      'analytics_storage': 'denied',
      'functionality_storage': 'denied',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 2000,
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Override consent values are set OK
  code: |-
    defaultMockData.defaultsOverrides = [
      {
        "analytics":"granted",
        "advertisement":"denied",
        "functionality":"granted",
        "personalization":"denied",
        "ad_user_data": "granted",
        "ad_personalization": "granted",
        "region":"",
      }
    ];

    // Call runCode to run the template's code.
    runCode(defaultMockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'denied',
      'ad_user_data': 'granted',
      'ad_personalization': 'granted',
      'analytics_storage': 'granted',
      'functionality_storage': 'granted',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 2000
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Override consent values region is setted OK
  code: |-
    defaultMockData.defaultsOverrides = [
      {
        "analytics":"granted",
        "advertisement":"denied",
        "functionality":"granted",
        "personalization":"denied",
        "ad_user_data": "denied",
        "ad_personalization": "denied",
        "region":"ES, US-CO",
      }
    ];

    // Call runCode to run the template's code.
    runCode(defaultMockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      'ad_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
      'analytics_storage': 'granted',
      'functionality_storage': 'granted',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 2000,
      'region': ["ES", "US-CO"],
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  // Default mocked data (data received when no options setted)
  const defaultMockData = {
    "adsDataRedaction":false,
    "urlPassThrough":false,
    "embedLawwwing":false,
    "waitForUpdate": 2000
  };


___NOTES___

Created on 2/8/2024, 7:50:26 PM


